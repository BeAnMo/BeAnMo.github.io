<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Middleware for useReducer</title><link href="https://fonts.googleapis.com/css2?family=Merriweather&family=Montserrat:wght@500&family=Source+Code+Pro&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><style>body{margin:0;padding:0;font-size:1.1rem;font-weight:500;font-family:Merriweather,serif;background-color:#fbfbfb;color:#444}h1,h2,h3,h4,h5,h6{font-family:Montserrat,-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:1rem 0}p{margin:1rem 0}pre{background-color:#eee;padding:.5rem;width:100%;overflow:auto;line-height:1rem}code{font-family:Source Code Pro,monospace;color:#00a19c}a{color:#0083c1}a:hover{color:#00a19c}a:active{color:#f98e2c}a:visited{color:#ce112d}</style><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="/assets/css/prism-theme.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-178156821-2"></script><script>window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-178156821-2');</script></head><body><nav class="navbar"><h3><a href="/#about-me">Benjamin Morin</a></h3><div class="navbar-links"></div></nav><main class="container"><article class="content"><header><h1 style="margin-bottom: 0;">Middleware for useReducer</h1><h5 style="margin-top: 0;" class="lt-text">Mon Nov 02 2020</h5></header><section><div class="post-body"><p>One of the great things about <a href="https://redux.js.org/" target="_blank" rel="noopener">Redux</a> is the ability to extend the functionality of the dispath function with middleware. There's enormous possibility when intercepting actions, but it's not always appropriate to rely on global state management. It often makes sense to keep state local to a component.</p><p>Fortunately, there's the <code>useReducer</code> hook. It follows a similar pattern to Redux: dispatch an action, call a reducer, then update the state. Turns out that just like Redux, <code>useReducer</code> can also accept middleware to extend functionality.</p><p>Why use middleware within a component? It abstracts away generic functionality, helping separate different logic rather than mashing it together in one location. For instance, a component is fetching data and may need to retry failed requests. A middleware function can handle all retrying logic, keeping the responsibility away from the component itself.</p><p>There's a hook based on <code>useReducer</code> in <a href="/posts/2020/use-api-state">useApiState Hook</a> that gives an example of <code>useReducer</code> middleware, but it suffers from a serious defect.</p><pre class="language-js"><code class="language-js"><span class="token comment">// action.type is one of "FETCH" | "SUCCESS" | "FAILURE"</span><br><span class="token keyword">const</span> <span class="token function-variable function">fetcher</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">caller</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// Ensure that the current action is dispatched.</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">FETCH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">caller</span><span class="token punctuation">(</span><span class="token operator">...</span>action<span class="token punctuation">.</span>args<span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">SUCCESS</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FAILURE</span><span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2>The Problem</h2><p>The problem may not be initially evident, the curried function signature takes a few seconds to fully sink in. <code>caller</code> is the async function passed to <code>useApiState</code> initially. The function returned is the middleware function signature of <code>dispatch =&gt; action</code>. Each action encountered is passed through to the next dispatch.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">useApiState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">caller<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><span class="token constant">INITIAL_STATE</span><span class="token punctuation">,</span><br>    <span class="token operator">...</span>initialState<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> enhancedDispatch <span class="token operator">=</span> <span class="token function">fetcher</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">enhancedDispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>While the pattern works for here, the problem is <code>dispatch</code> only refers to the <em>next</em> dispatch function in the middleware chain. At the moment, that's <code>reducer</code>, but what if the component needs to use retrying and logging middleware?</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Dispatching:\t</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">retryMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">FAILURE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"RETRY"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span><br>      args<span class="token operator">:</span> action<span class="token punctuation">.</span>args<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The revised <code>useApiState</code> can take any arbitrary middleware, provided they follow the <code>dispatch =&gt; action</code> signature.</p><pre class="language-js"><code class="language-js"><span class="token comment">// Simple function composition: pipe(x, h, g, f) == f(g(h(x)))</span><br><span class="token keyword">const</span> <span class="token function-variable function">pipe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> <span class="token operator">...</span>proc</span><span class="token punctuation">)</span> <span class="token operator">=></span> procs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> proc</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">proc</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">useApiState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">caller<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><span class="token constant">INITIAL_STATE</span><span class="token punctuation">,</span><br>    <span class="token operator">...</span>initialState<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> enhancedDispatch <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> <span class="token function">fetcher</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">enhancedDispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>As a demonstration of the shortcomings, <code>RecentActivities</code> is reused. Given a Reddit username, the component will render a table based on recent user activity. In order to see actions, <code>useApiState</code> will take a simple logging middleware.</p><iframe loading="lazy" src="https://stackblitz.com/edit/use-api-state-original-middleware?ctl=1&devtoolsheight=33&embed=1&file=src/useApiState/useApiState.js&theme=light" style="height: 550px; width: 100%;"></iframe><h2>Debugging</h2><p>Monitoring the logging immediately shows problems. The initial <code>FETCH</code> is logged by the logger, but beyond that, nothing else is logged.</p><p>The curried function is awkward to step through but not impossible. Here is the unrolled version of the middleware chain.</p><pre class="language-js"><code class="language-js"><span class="token function">logMiddleware</span><span class="token punctuation">(</span><span class="token function">retryMiddleware</span><span class="token punctuation">(</span><span class="token function">fetcher</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Still confusing? Imagine an initial action:</p><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'user-name'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></code></pre><p>The first function encountered, the logger, will just log <code>Dispatching: FETCH</code>.</p><pre class="language-js"><code class="language-js"><span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">retryMiddleware</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// does logging and dispatches the next function</span><br>  <span class="token keyword">return</span> <span class="token function">retryMiddleware</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Ok, that's doing what it needs to so far. Next is <code>retryMiddleware</code>. There's nothing to retry at the moment, so like the logger, it will call the next function.</p><pre class="language-js"><code class="language-js"><span class="token function-variable function">retryMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fetcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// action is FETCH, continue to fetchMiddleware</span><br>  <span class="token keyword">return</span> <span class="token function">fetcher</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>When hitting <code>fetcher</code>, things start happening. First off, the next function is the actual dispatch which will call the reducer and create the next state. <code>dispatch</code> will create the next state before <code>caller</code> is called.</p><p>The result of <code>caller</code> dispatches directly to the reducer. There's no chance to actually retry the response. Likewise, regardless of the response action dispatched, it will never be seen by the logger.</p><p>The failure of this pattern is that any intercepted actions can only lead to the next function in the middleware. This works fine for fetching; one of two actions are dispatched, both of which immediately generate the next state. However, this pattern falls short with other middleware.</p><pre class="language-js"><code class="language-js"><span class="token function-variable function">fetcher</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// Dispatches directly to the reducer.</span><br>  <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// The state at this point is potentially { loading: true, error: null, data: null }.</span><br><br>  <span class="token comment">// action is FETCH, perform async operation</span><br>  <span class="token function">caller</span><span class="token punctuation">(</span><span class="token operator">...</span>action<span class="token punctuation">.</span>args<span class="token punctuation">)</span><br>    <span class="token comment">// Dispatch can only call next dispatch function: the reducer.</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">SUCCESS</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token comment">// No opportunity to retry or even to log.</span><br>    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FAILURE</span><span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2>The Solution?</h2><p>A <code>FAILURE</code> needs to run through the entire middleware chain. How can this be achieved?</p><p>Revisiting the Redux middleware signature, shows where the deficiency is. The key ingredient is <code>store</code>, which not surprisingly is the Redux store instance. The important aspect is that <code>store</code> hsa access to the current state of the store and the full, top-level dispatch function. Here, <code>next</code> behaves just like the current middleware for <code>useApiState</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token parameter">middleware</span> <span class="token operator">=></span> <span class="token parameter">store</span> <span class="token operator">=></span> <span class="token parameter">next</span> <span class="token operator">=></span> <span class="token parameter">action</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> store<span class="token punctuation">;</span><br><br>    <span class="token comment">// Possible patterns:</span><br><br>    <span class="token comment">// Advance to next dispatch function.</span><br>    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Call top level dispatch to pass a new action</span><br>    <span class="token comment">// through the entire middleware chain.</span><br>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'AN_ACTION'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Intercept current action and enhance it.</span><br>    <span class="token keyword">if</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ANOTHER_ACTION'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        type<span class="token operator">:</span> action<span class="token punctuation">.</span>type<span class="token punctuation">,</span><br>        data<span class="token operator">:</span> <span class="token function">enhanceData</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>data<span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2>useEnhancedReducer</h2><p>The middleware for <code>useApiState</code> needs reconfiguring to accept the store like Redux middleware. In fact, it might as well go the extra mile and make <code>useApiState</code> compatible with Redux middleware.</p><p>At this point, reconfiguring <code>useApiState</code> is a complex task on its own. A dedicated solution is called for. Afterall, using middleware in <code>useReducer</code> can be extended beyond API calls.</p><p>How about a new hook?</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">useEnhancedReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">// The new and improved useApiState.</span><br><span class="token keyword">const</span> useApiState <span class="token operator">=</span> <span class="token punctuation">(</span>caller<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useEnhancedReducer</span><span class="token punctuation">(</span><br>    reducer<span class="token punctuation">,</span><br>    <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token constant">INITIAL_STATE</span><span class="token punctuation">,</span> <span class="token operator">...</span>initialState <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">[</span><span class="token operator">...</span>middleware<span class="token punctuation">,</span> <span class="token function">fetchMiddleware</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">]</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Incorporating Existing Patterns</h2><p>Ok, that's about 90% done, but it needs the same store api that Redux provides in order to access the top level dispatch function. As luck would have it, there's already an existing hook available to build off of, <a href="https://github.com/venil7/react-usemiddleware" target="_blank" rel="noopener">react-usemiddleware</a>. It uses Redux's own <code>applyMiddleware</code> function for integration with the existing Redux ecosystem.</p><pre class="language-js"><code class="language-js"><span class="token comment">// react-usemiddleware</span><br><span class="token keyword">const</span> <span class="token function-variable function">useMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initState<span class="token punctuation">,</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> <span class="token function-variable function">getState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> state <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">(</span>getStore<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> dispatch<span class="token operator">:</span> dispatch_<span class="token punctuation">,</span> getState <span class="token punctuation">}</span> <span class="token operator">=</span> store<span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatch_<span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>getStore</code> provides the interface needed for <code>applyMiddleware</code> to function properly. <code>applyMiddleware(...)(getStore)</code> actually returns <em>another</em> function, which has the same inputs as <code>useReducer</code>, a reducer and the initial state. It is called without arguments because <code>getStore</code> already provides the needed information.</p><pre class="language-js"><code class="language-js"><span class="token comment">// redux applyMiddleware (modified for readability)</span><br><span class="token keyword">const</span> <span class="token function-variable function">applyMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">createStore</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><br>  <span class="token parameter">reducer<span class="token punctuation">,</span><br>  preloadedState</span><br><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// No need to pass a reducer &amp; state to createStore because "getStore"</span><br>  <span class="token comment">// has everything needed.</span><br>  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> preloadedState<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><br>      <span class="token string">"Dispatching while constructing your middleware is not allowed. "</span> <span class="token operator">+</span><br>        <span class="token string">"Other middleware would not be applied to this dispatch."</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span><br>    getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span><br>    <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Middlewares are bound to the store API:</span><br>  <span class="token comment">// "store => next => action => any" becomes "next => action => any"</span><br>  <span class="token keyword">const</span> chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Applies middleware chain to dispatch:</span><br>  <span class="token comment">// many "next => action" becomes one "action => any"</span><br>  dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span>store<span class="token punctuation">,</span><br>    dispatch<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>applyMiddleware</code> provides the missing ingredient, the top-level dispatch function. It creates the <code>middlewareAPI</code> and maps it to each middleware function. Logging &amp; retrying middleware can be updated to accept the top-level dispatch.</p><pre class="language-js"><code class="language-js"><span class="token comment">// This is now fully compatible Redux middleware.</span><br><span class="token keyword">const</span> <span class="token function-variable function">retryMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// If a failure is encountered, send a new FETCH back</span><br>  <span class="token comment">// through the entire middleware chain.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">FAILURE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"RETRY"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span><br>      args<span class="token operator">:</span> action<span class="token punctuation">.</span>args<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token comment">// By default, call next dispatch.</span><br>    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cCurrent: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">formatState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    <span class="token string">"color: green; font-weight: bolder;"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cDispatching: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    <span class="token string">"color: blue; font-weight: bolder"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cNext: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">formatState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    <span class="token string">"color: red; font-weight: bolder"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">formatState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> error<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, loading: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loading<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, dataLength: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><br>    <span class="token operator">!</span>data <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>length<br>  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2>More Debugging</h2><p>There are a few problems still. Crucially, using <code>getState</code> in middleware for <code>useMiddleware</code>, the state only references the initial state, regardless of which actions are dispatched. Here is the output using the custom logger.</p><pre class="language-js"><code class="language-js"><span class="token comment">// For simplicity, logging lacks the appropriate groupings.</span><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FETCH</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FAILURE</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">RETRY</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FETCH</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">SUCCESS</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span></code></pre><p>This is where the complexities and nuances of hooks throw serious obstacles to the goal of using middleware with <code>useReducer</code>. In order to access updated state within <code>getState</code>, a ref is used. Refs are convenient for storing freely mutable data, but a drawback is that a mutated ref does not trigger a render. Still, syncing the current state with a ref via <code>useEffect</code> might just be enough.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">useEnhancedReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> enhanceStore <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> _state <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    _state<span class="token punctuation">.</span>current <span class="token operator">=</span> state<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">getStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>    dispatch<span class="token punctuation">,</span><br>    <span class="token function-variable function">getState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _state<span class="token punctuation">.</span>current<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">enhanceStore</span><span class="token punctuation">(</span>getStore<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch<span class="token operator">:</span> enhancedDispatch <span class="token punctuation">}</span> <span class="token operator">=</span> store<span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> enhancedDispatch<span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The above modifications are on the right track, but there are two more issues to tackle.</p><pre class="language-js"><code class="language-js">Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FETCH</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FAILURE</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">RETRY</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FETCH</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">SUCCESS</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span></code></pre><p>The first is that <code>RecentActivities</code> hangs in the loading state, despite actually having the proper api state data. This goes back to the issue of refs. The updated state ref does not trigger the necessary render for <code>RecentActivities</code>. There's a quick and dirty fix to force a render, but it is not ideal.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">useEnhancedReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...</span><br><br>  <span class="token comment">// Saving the ref within useState causes the same problems</span><br>  <span class="token comment">// as the original configuration.</span><br>  <span class="token keyword">const</span> _state <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>_<span class="token punctuation">,</span> forceUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    _state<span class="token punctuation">.</span>current <span class="token operator">=</span> state<span class="token punctuation">;</span><br>    <span class="token comment">// Trigger a render after the ref is changed.</span><br>    <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre><p><code>forceUpdate</code> will trigger a rerender, ensuring the state ref data is properly reflected in the component. That solves the permanent loading.</p><p>Next, logging the &quot;next&quot; state doesn't actually log the next state. Unfortunately, component state &amp; rendering are asynchronous. The logger can't access the current state synchronously after calling the next dispatch. Redux is not tied to the component lifecycle, so it avoids this problem. Turning <code>getState</code> asynchronous breaks Redux middleware compatibility. Again, a quick and dirty hack is called for.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  console<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cCurrent: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">logState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    <span class="token string">"color: green; font-weight: bolder;"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cDispatching: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>    <span class="token string">"color: blue; font-weight: bolder"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// The timeout allows access to the current state.</span><br>  <span class="token comment">// It can potentially cause other bugs however.</span><br>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cNext: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">logState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><br>      <span class="token string">"color: red; font-weight: bolder"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    console<span class="token punctuation">.</span><span class="token function">groupEnd</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The <code>setTimeout</code> call allows access to the actual next state. Finally, here's the expected logging output.</p><pre class="language-js"><code class="language-js">Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FETCH</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FAILURE</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">RETRY</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">FETCH</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br><br>Current<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><br>Dispatching<span class="token operator">:</span> <span class="token constant">SUCCESS</span><br>Next<span class="token operator">:</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> dataLength<span class="token operator">:</span> <span class="token number">16</span> <span class="token punctuation">}</span></code></pre><h2>Done?</h2><p>The revised <code>useApiState</code> incorporates <code>useEnhancedReducer</code>, which mostly achieves the goal of using middleware with <code>useReducer</code>.</p><iframe loading="lazy" src="https://stackblitz.com/edit/use-api-state-improved-middleware?ctl=1&devtoolsheight=33&embed=1&file=src/useEnhancedReducer/index.js&theme=light" style="height: 550px; width: 100%;"></iframe><p>Unfortunately, for all the work done to make <code>useReducer</code> compatible with Redux middleware, there are serious issues that make a 1-to-1 substitution untenable. The async nature of the component lifecycle clashes with Redux's synchronous APIs. Additionally, ensuring fresh state within middleware and components fights against React's rendering patterns.</p><p>Still, the middleware pattern has plenty of potential for local component state. Beyond fetching data, it is easy to imagine middleware to handle complex form logic without having to pollute global Redux state. It can be easy to adjust state shape when intercepting actions dispatched by form input handlers.</p></div></section></article></main><footer class="container" style="height: 4rem;"><div class="content" style="display: flex; justify-content: space-between; align-items: baseline;"><a href="/">Back Home</a><h5>&copy; 2020 Benjamin Morin</h5></div></footer></body></html>