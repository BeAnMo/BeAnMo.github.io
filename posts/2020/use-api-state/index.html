<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>useApiState Hook</title><link href="https://fonts.googleapis.com/css2?family=Merriweather&family=Montserrat:wght@500&family=Source+Code+Pro&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><style>body{margin:0;padding:0;font-size:1.1rem;font-weight:500;font-family:Merriweather,serif;background-color:#fbfbfb;color:#444}h1,h2,h3,h4,h5,h6{font-family:Montserrat,-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:1rem 0}p{margin:1rem 0}pre{background-color:#eee;padding:.5rem;width:100%;overflow:auto;line-height:1rem}code{font-family:Source Code Pro,monospace;color:#00a19c}a{color:#0083c1}a:hover{color:#00a19c}a:active{color:#f98e2c}a:visited{color:#ce112d}</style><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="/assets/css/prism-theme.css"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-178156821-2"></script><script>window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-178156821-2');</script></head><body><nav class="navbar"><h3><a href="/#about-me">Benjamin Morin</a></h3><div class="navbar-links"></div></nav><main class="container"><article class="content"><header><h1 style="margin-bottom: 0;">useApiState Hook</h1><h5 style="margin-top: 0;" class="lt-text">Sat Oct 24 2020</h5></header><section><div class="post-body"><p>Fetching data from within components (React or otherwise) carries with it the task of maintaining state beyond the actual response. How much needs maintaining is based on any number of questions. How important is the data to the UI? Is the data being currently fetched? Has it arrived yet? Was there an error? In certain circumstances, like a tracking beacon, a developer might not need to worry about these questions. However, if the fetched data is critical to the UI, not managing these states can crash the entire app.</p><p>This extra state (such as a loading or error flag) adds another layer of complexity to a component. This oftens turns straightforward component logic into a mess of updating response states alongside everything the component is handling.</p><p>As an example, say a new feature for an app requires the display of a Reddit user's most recent history. This includes a table of the post and comment data, as well as a text input that calls Reddit for the given user.</p><p>There's a row of data.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">Row</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> created<span class="token punctuation">,</span> subreddit<span class="token punctuation">,</span> score<span class="token punctuation">,</span> link <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>tr<span class="token operator">></span><br>      <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token punctuation">{</span>created<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>      <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token punctuation">{</span>subreddit<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>      <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token punctuation">{</span>score<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>      <span class="token operator">&lt;</span>td<span class="token operator">></span><br>        <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token punctuation">{</span>link<span class="token punctuation">}</span> target<span class="token operator">=</span><span class="token string">"_blank"</span> rel<span class="token operator">=</span><span class="token string">"noopener"</span><span class="token operator">></span><br>          Link<br>        <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The table that contains the rows.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">ActivityTable</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> rows <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>table<span class="token operator">></span><br>      <span class="token operator">&lt;</span>thead<span class="token operator">></span><br>        <span class="token operator">&lt;</span>tr<span class="token operator">></span><br>          <span class="token operator">&lt;</span>td<span class="token operator">></span>Date<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>          <span class="token operator">&lt;</span>td<span class="token operator">></span>Subreddit<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>          <span class="token operator">&lt;</span>td<span class="token operator">></span>Score<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>          <span class="token operator">&lt;</span>td<span class="token operator">></span>Link<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span><br>        <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>thead<span class="token operator">></span><br>      <span class="token operator">&lt;</span>tbody<span class="token operator">></span><br>        <span class="token punctuation">{</span>rows<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">row<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><br>          <span class="token operator">&lt;</span>Row key<span class="token operator">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stats-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>row<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><br>      <span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The text input to grab a username. (For text inputs, listening to the &quot;change&quot; event prevents the <code>onChange</code> prop from firing with every key press. This prevents spamming Reddit with half-finished usernames).</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">UserForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value<span class="token punctuation">,</span> onChange<span class="token punctuation">,</span> disabled <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> $input <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    $input<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"change"</span><span class="token punctuation">,</span> handleChange<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span>$input<span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"text"</span> defaultValue<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> disabled<span class="token operator">=</span><span class="token punctuation">{</span>disabled<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Bringing it all together.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">RecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> setUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">handleUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setUser</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>section<span class="token operator">></span><br>      <span class="token operator">&lt;</span>UserForm value<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleUser<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br><br>      <span class="token operator">&lt;</span>ActivityTable rows<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>section<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Great, if <code>RecentActivity</code> is basically done, now it just needs the data source. How about adding the Reddit user service?</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">redditUrl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">pathname</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"https://www.reddit.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  base<span class="token punctuation">.</span>pathname <span class="token operator">=</span> pathname<span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> base<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">getRecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> children <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><br>    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> created_utc<span class="token punctuation">,</span> subreddit<span class="token punctuation">,</span> permalink<span class="token punctuation">,</span> score <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><br>      created<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>created_utc <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      subreddit<span class="token punctuation">,</span><br>      link<span class="token operator">:</span> <span class="token function">redditUrl</span><span class="token punctuation">(</span>permalink<span class="token punctuation">)</span><span class="token punctuation">,</span><br>      score<span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">fetchUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token function">redditUrl</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">u/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/.json?sort=new</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>getRecentActivity<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="fetch-1">Version 1</h2><p>Nothing crazy. It's just taking a few fields from response data and doing some simple formatting. Now to add the fetching to the <code>RecentActivity</code> component.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">RecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> setUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>rows<span class="token punctuation">,</span> setRows<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> user <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">setUser</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">fetchUser</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>setRows<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">></span><br>      <span class="token operator">&lt;</span>UserForm value<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>      <span class="token operator">&lt;</span>ActivityTable setRows<span class="token operator">=</span><span class="token punctuation">{</span>setRows<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The above represents one of the simplest patterns to loading data. It does what it needs to but operates on the happiest of paths. What if the table is already displaying data for <em>user456</em> but the app user decides to search for <em>IceyHotStunta</em> and it fails? Or what if a request takes far longer than expected? These end up with scenarios where the text input value no longer references the table data.</p><p>This calls for a revision of <code>RecentActivity</code>.</p><h2 id="fetch-2">Version 2</h2><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">RecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> setUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>error<span class="token punctuation">,</span> setError<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>rows<span class="token punctuation">,</span> setRows<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">setError</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">setRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">fetchUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>setRows<span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>setError<span class="token punctuation">)</span><br>        <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token operator">&lt;</span>div<span class="token operator">></span><br>      <span class="token operator">&lt;</span>UserForm value<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span> disabled<span class="token operator">=</span><span class="token punctuation">{</span>loading<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br><br>      <span class="token punctuation">{</span>error <span class="token operator">?</span> <span class="token punctuation">(</span><br>        <span class="token operator">&lt;</span>p<span class="token operator">></span>An Error occurred<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><br>      <span class="token punctuation">)</span> <span class="token operator">:</span> loading <span class="token operator">?</span> <span class="token punctuation">(</span><br>        <span class="token operator">&lt;</span>p<span class="token operator">></span>Fetching user<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><br>      <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><br>        <span class="token operator">&lt;</span>ActivityTable rows<span class="token operator">=</span><span class="token punctuation">{</span>rows<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><br>      <span class="token punctuation">)</span><span class="token punctuation">}</span><br>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Now any issues syncing data between the input and table are resolved. If a user has been entered, the table display can only be the error/loading indicators or the user's activity table. It looks simple enough in this example, but data fetching components can get very complex very quickly.</p><p>The <code>handleChange</code> function tips off where this component is headed when additional functionality gets tacked on. In order to ensure no data gets mixed up between users and to ensure data will render properly, the <code>loading</code>, <code>error</code>, and <code>stats</code> state values need to be reset manually with each new user.</p><p>Error and loading states are important but how they are updated is not the component's concern. By managing it locally, not only does it bleed into other logic, but it costs rerenders; each <code>set...</code> call triggers a rerender, totalling 6 per <code>handleChange</code> call. If <code>ActivityTable</code> contained very busy and/or many child components, extra renders can sabotage performance.</p><p>There are plenty of solutions for handling data fetching in components. Luckily, React's <code>useReducer</code> hook provides a solid foundation for a more concise pattern for fetching.</p><p>As with the earlier versions, there is state to keep track of, only this time it will all be bundled into a single object.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">INITIAL_STATE</span> <span class="token operator">=</span> <span class="token punctuation">{</span><br>  error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>  data<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Rather than setting state fields individually, bulk transitions can be triggered using the following actions.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">FETCH</span> <span class="token operator">=</span> <span class="token string">"FETCH"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">FAILURE</span> <span class="token operator">=</span> <span class="token string">"FAILURE"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">SUCCESS</span> <span class="token operator">=</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">;</span></code></pre><p>Next, the reducer is set up to handle the actual transitions.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token constant">FETCH</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>        loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>        data<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">case</span> <span class="token constant">FAILURE</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span>state<span class="token punctuation">,</span><br>        loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>        error<span class="token operator">:</span> action<span class="token punctuation">.</span>error<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">case</span> <span class="token constant">SUCCESS</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token punctuation">{</span><br>        <span class="token operator">...</span>state<span class="token punctuation">,</span><br>        loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>        data<span class="token operator">:</span> action<span class="token punctuation">.</span>data<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">default</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> state<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>FETCH</code> transitions to the loading state, clearing out old data and errors with it. <code>SUCCESS</code> and <code>FAILURE</code> transition out of the loading state and update the <code>data</code> or <code>error</code> fields where appropriate. All 3 fields are updated in a single render, as opposed to relying on multiple <code>useState</code> instances.</p><p>Here is the in-progress <code>useApiState</code> hook. It takes two arguments: <code>caller</code>, the data fetching function and optionally, <code>initialState</code>, which allows for scenarios where a component fetches data when mounting (set with <code>{ loading: true }</code>). A <code>FETCH</code> is dispatched with arguments for <code>caller</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">useApiState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">caller<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><span class="token constant">INITIAL_STATE</span><span class="token punctuation">,</span><br>    <span class="token operator">...</span>initialState<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="fetch-3">Version 3</h2><p>From the perspective of <code>RecentActivity</code>, that's it. No other information is needed to fetch data. All of the response state management resides in the <code>useApiHook</code>.</p><p>Notice how the component body looks as simple as the first <code>RecentActivity</code> <a href="#fetch-1">version</a> to fetch data but provides the error/loading management of the second <a href="#fetch-2">version</a>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">RecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> setUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> error<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">,</span> getRecentActivity<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useApiState</span><span class="token punctuation">(</span>fetchUser<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">getRecentActivity</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// ...rendering</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>While <code>RecentActivity</code> is now complete, the <code>useApiState</code> hook needs finishing.</p><p>The advantage of using reducers/actions is predictable state updates, which are achieved through pure reducers. A reducer takes in the current state and action and returns the next state based on the action. How does an asynchronous function call work within that context? Turns out that <code>useReducer</code> can use middleware in much the same way as <a href="https://redux.js.org/" target="_blank" rel="noopener">Redux</a>.</p><p>The only action that needs manual dispatching is <code>FETCH</code>. Middleware can intercept a <code>FETCH</code>, perform a request, and then dispatch a followup action based on the response.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">fetchMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">caller</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// Ensure that the current action is dispatched.</span><br>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">FETCH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">caller</span><span class="token punctuation">(</span><span class="token operator">...</span>action<span class="token punctuation">.</span>args<span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">SUCCESS</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FAILURE</span><span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>useApiState</code> needs a slight revision to wrap <code>dispatch</code> with <code>fetchMiddleware</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">useApiState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">caller<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token operator">...</span><span class="token constant">INITIAL_STATE</span><span class="token punctuation">,</span><br>    <span class="token operator">...</span>initialState<span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> enhancedDispatch <span class="token operator">=</span> <span class="token function">fetchMiddleware</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">enhancedDispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">FETCH</span><span class="token punctuation">,</span> args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>The final piece is in place. The mess of state handling in <code>handleChange</code> gets pushed into the dispatch function, eliminating the need for manual updates. It's more efficient as well. Remember, multiple <code>useState</code> instances contributed to excess rendering. With <code>useApiState</code>, the amount of rendering by calling <code>handleChange</code> is halved. One render for setting a user, one render for <code>FETCH</code>, and one for either <code>SUCCESS</code> or <code>FAILURE</code>.</p><h2>Wrapping Up</h2><p><code>useApiState</code> gives developers a tool to help abstract away the highly repetitive and often troublesome task of handling of response states. While it appears more complex than the alternatives, it unloads a sizeable state burden for data heavy components.</p><p>Here's the live version, with some test data as opposed to Reddit API calls.</p><iframe src="https://stackblitz.com/edit/use-api-state?embed=1&file=src/RecentActivity.v3.jsx" style="height: 550px; width: 100%;"></iframe><h3>Addendum</h3><h4>More Middleware</h4><p><code>fetchMiddleware</code> is required to do the actual fetching, but it is not the only middleware than can be useful. Additonal functionality like logging, caching responses, and paging through data can all be accomplished within middleware. Unfortunately, the overall configuration here does not extend well enough to make much use of other middleware. This will be explored more in depth in <a href="/posts/2020/usereducer-middleware"><strong>Middleware for useReducer</strong></a>.</p><h4><code>useEffect</code> to Handle Fetching</h4><p>The above examples stuff all the functionality into <code>handleChange</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">RecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...state</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// ...a bunch of other operations</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// ...render</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>That works but leaves the <code>handleChange</code> more complicated than necessary. The goal of implementing <code>useApiState</code> is to create a better separation of concerns to reduce the cognitive load. A cleaner alternative is to decouple the user update from the actual fetching with <code>useEffect</code>.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">RecentActivity</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...state</span><br><br>  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">user</span> <span class="token operator">=></span> <span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>      <span class="token comment">// ...a bunch of other operations</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// ...render</span></code></pre><p>Any time <code>user</code> is set to a non-empty string, it will call the fetch operation. This allows <code>handleChange</code> to focus solely on updating the user value.</p></div></section></article></main><footer class="container" style="height: 4rem;"><div class="content" style="display: flex; justify-content: flex-end;"><h5>&copy; 2020 Benjamin Morin</h5></div></footer></body></html>